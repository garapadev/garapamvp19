'use client'

import { createContext, useContext, ReactNode } from 'react'

interface Tenant {
  id: string
  name: string
  domain?: string
  isActive: boolean
  createdAt: Date
  updatedAt: Date
}

interface TenantContextType {
  tenant: Tenant | null
  setTenant: (tenant: Tenant | null) => void
  isLoading: boolean
}

const TenantContext = createContext<TenantContextType | undefined>(undefined)

export function TenantProvider({ children }: { children: ReactNode }) {
  const defaultTenant: Tenant = {
    id: 'default',
    name: 'GarapaCRM',
    domain: 'localhost',
    isActive: true,
    createdAt: new Date(),
    updatedAt: new Date()
  }

  const value: TenantContextType = {
    tenant: defaultTenant,
    setTenant: () => {
      console.warn('Tenant change is not available in single tenant mode')
    },
    isLoading: false
  }

  return (
    <TenantContext.Provider value={value}>
      {children}
    </TenantContext.Provider>
  )
}

export function useTenant() {
  const context = useContext(TenantContext)
  if (context === undefined) {
    throw new Error('useTenant must be used within a TenantProvider')
  }
  return context
}

export function useTenantId(): string {
  const { tenant } = useTenant()
  return tenant?.id || 'default'
}

export function useIsMultitenant(): boolean {
  return process.env.NEXT_PUBLIC_MULTITENANT === 'true'
}

export function getServerTenantId(): string {
  return 'default'
}

export function createTenantFilter(tenantId?: string) {
  const id = tenantId || getServerTenantId()
  return { tenantId: id }
}

export function hasTenantId(obj: any): obj is { tenantId: string } {
  return obj && typeof obj === 'object' && 'tenantId' in obj
}